package main

import (
	"context"
	"flag"
	"fmt"
	"io"
	stdlog "log"
	"net/http"
	"net/url"
	"os"
	"path/filepath"
	"strconv"
	"strings"
	"time"

	"github.com/micromdm/micromdm/mdm"
	"github.com/micromdm/micromdm/mdm/enroll"
	"github.com/micromdm/micromdm/pkg/crypto"
	httputil2 "github.com/micromdm/micromdm/pkg/httputil"
	"github.com/micromdm/micromdm/platform/apns"
	"github.com/micromdm/micromdm/platform/appstore"
	appsbuiltin "github.com/micromdm/micromdm/platform/appstore/builtin"
	"github.com/micromdm/micromdm/platform/blueprint"
	blueprintbuiltin "github.com/micromdm/micromdm/platform/blueprint/builtin"
	"github.com/micromdm/micromdm/platform/challenge"
	"github.com/micromdm/micromdm/platform/command"
	"github.com/micromdm/micromdm/platform/config"
	depapi "github.com/micromdm/micromdm/platform/dep"
	"github.com/micromdm/micromdm/platform/dep/sync"
	"github.com/micromdm/micromdm/platform/device"
	devicebuiltin "github.com/micromdm/micromdm/platform/device/builtin"
	"github.com/micromdm/micromdm/platform/profile"
	block "github.com/micromdm/micromdm/platform/remove"
	"github.com/micromdm/micromdm/platform/user"
	userbuiltin "github.com/micromdm/micromdm/platform/user/builtin"
	vppapi "github.com/micromdm/micromdm/platform/vpp"
	"github.com/micromdm/micromdm/server"

	"github.com/boltdb/bolt"
	"github.com/go-kit/kit/auth/basic"
	"github.com/go-kit/kit/log"
	httptransport "github.com/go-kit/kit/transport/http"
	"github.com/gorilla/handlers"
	"github.com/groob/finalizer/logutil"
	"github.com/micromdm/go4/env"
	"github.com/micromdm/go4/httputil"
	"github.com/micromdm/go4/version"
	scep "github.com/micromdm/scep/v2/server"
	"github.com/pkg/errors"
	"golang.org/x/crypto/acme/autocert"
)

const homePage = `<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>VMIT MDM</title>
  <style>
@font-face {
  font-family: system;
  font-weight: 900;
  src: local(".SFNSText-Heavy"), local(".HelveticaNeueDeskInterface-Heavy"), local(".LucidaGrandeUI"), local("Ubuntu Heavy"), local("Segoe UI Heavy"), local("Roboto-Heavy"), local("DroidSans"), local("Tahoma");
}

/* Global */
body {
  position: relative;
  font-family: "system", "Helvetica Neue", "Helvetica", "Arial", sans-serif;
  margin: 0;
  text-align: center;
  font-size: 35px;
}

.enrollment {
  background: #98db3a;
  color: #fff;
  padding: 15px;
  border-radius: 3px;
  font-size: 30px;
  text-decoration: none;
}
  </style>
 </head>
<body>

<h1>VMIT Technologies PVT LTD</h1>
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="204" height="192" viewBox="0 0 204 192" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M53.069 0c0.43 0.222 0.834 0.475 1.234 0.746 0.178 0.12 0.356 0.24 0.535 0.36l0.112 0.075c0.397 0.266 0.796 0.528 1.195 0.79l0.217 0.142 0.437 0.286q0.488 0.32 0.976 0.64L58.317 3.395l0.216 0.142 0.108 0.071L89.258 23.7a2204.563 2204.563 0 0 0 1.463 0.96l0.217 0.143c0.506 0.332 1.01 0.666 1.513 1.002 0.35 -0.187 0.681 -0.394 1.01 -0.616q0.151 -0.101 0.302 -0.203l0.156 -0.105c0.252 -0.169 0.505 -0.336 0.759 -0.502l0.151 -0.1 0.456 -0.3c0.838 -0.551 0.838 -0.551 1.672 -1.106 0.433 -0.289 0.869 -0.575 1.304 -0.861 0.713 -0.469 1.426 -0.939 2.136 -1.414 0.777 -0.52 1.559 -1.032 2.34 -1.546 0.513 -0.337 1.025 -0.675 1.538 -1.012l0.307 -0.203c0.683 -0.45 0.683 -0.45 1.364 -0.903 0.466 -0.311 0.935 -0.619 1.403 -0.927 0.713 -0.469 1.426 -0.939 2.136 -1.414 0.777 -0.52 1.559 -1.032 2.34 -1.546 0.513 -0.337 1.025 -0.675 1.538 -1.012l0.307 -0.203c0.682 -0.449 0.682 -0.449 1.362 -0.901 0.584 -0.39 1.171 -0.775 1.757 -1.161 0.513 -0.338 1.026 -0.676 1.537 -1.017 0.433 -0.289 0.868 -0.575 1.303 -0.861 0.713 -0.469 1.426 -0.939 2.136 -1.414 0.777 -0.52 1.559 -1.032 2.34 -1.546 0.513 -0.337 1.025 -0.675 1.538 -1.012l0.307 -0.203c0.683 -0.45 0.683 -0.45 1.364 -0.903a171.109 171.109 0 0 1 0.957 -0.634l0.146 -0.096q0.306 -0.201 0.612 -0.403c0.776 -0.51 0.776 -0.51 1.547 -1.029l0.206 -0.139a48.525 48.525 0 0 0 0.368 -0.252l0.161 -0.109c0.045 -0.031 0.09 -0.062 0.137 -0.094L131.564 0l0.162 0.054c-0.049 0.092 -0.049 0.092 -0.098 0.187 -0.391 0.744 -0.774 1.492 -1.156 2.241a562.826 562.826 0 0 1 -1.109 2.164A801.015 801.015 0 0 0 128.372 6.573a888.274 888.274 0 0 1 -1.001 1.947 967.959 967.959 0 0 0 -1.066 2.075 1404.738 1404.738 0 0 1 -1.022 1.99 1348.153 1348.153 0 0 0 -0.972 1.892 958.654 958.654 0 0 1 -1.053 2.049 931.984 931.984 0 0 0 -1.011 1.967A1325.27 1325.27 0 0 1 121.286 20.368a1455.211 1455.211 0 0 0 -1.028 2.002 1531.812 1531.812 0 0 1 -1.088 2.118 1347.882 1347.882 0 0 0 -0.972 1.892 958.654 958.654 0 0 1 -1.053 2.049 931.984 931.984 0 0 0 -1.011 1.967A1325.27 1325.27 0 0 1 115.173 32.269a1459.376 1459.376 0 0 0 -1.028 2.002q-0.517 1.008 -1.035 2.015l-0.06 0.117 -0.9 1.749 -0.06 0.117a1649.636 1649.636 0 0 0 -1.043 2.032 1459.484 1459.484 0 0 1 -1.019 1.984A1396.299 1396.299 0 0 0 109.06 44.17q-0.517 1.008 -1.035 2.015l-0.06 0.117 -0.9 1.749 -0.06 0.117a1649.636 1649.636 0 0 0 -1.043 2.032 1459.484 1459.484 0 0 1 -1.019 1.984A1396.299 1396.299 0 0 0 103.975 54.07q-0.517 1.008 -1.035 2.015l-0.06 0.117 -0.9 1.749 -0.06 0.117a1649.636 1649.636 0 0 0 -1.043 2.032 1459.484 1459.484 0 0 1 -1.019 1.984A1396.299 1396.299 0 0 0 98.889 63.97q-0.517 1.008 -1.035 2.015l-0.06 0.117 -0.9 1.749 -0.06 0.117a1649.636 1649.636 0 0 0 -1.043 2.032 1449.152 1449.152 0 0 1 -1.019 1.984q-0.418 0.811 -0.834 1.624 -0.137 0.267 -0.274 0.533a189.718 189.718 0 0 0 -0.603 1.182 215.523 215.523 0 0 1 -0.256 0.504q-0.06 0.118 -0.119 0.237a49.823 49.823 0 0 1 -0.164 0.325l-0.093 0.185C92.344 76.71 92.344 76.71 92.181 76.764l-0.044 -0.088q-0.229 -0.46 -0.458 -0.919 -0.085 -0.17 -0.17 -0.341c-0.303 -0.609 -0.609 -1.215 -0.927 -1.816 -0.194 -0.367 -0.381 -0.738 -0.565 -1.11 -0.212 -0.426 -0.425 -0.851 -0.649 -1.271 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.911 -0.699 -1.371 -0.217 -0.436 -0.438 -0.869 -0.667 -1.298 -0.223 -0.421 -0.434 -0.848 -0.646 -1.274 -0.172 -0.345 -0.347 -0.687 -0.528 -1.027 -0.225 -0.422 -0.439 -0.85 -0.653 -1.278 -0.212 -0.426 -0.425 -0.851 -0.649 -1.271 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.911 -0.699 -1.371 -0.217 -0.436 -0.438 -0.869 -0.667 -1.298 -0.223 -0.421 -0.434 -0.848 -0.646 -1.274 -0.172 -0.345 -0.347 -0.687 -0.528 -1.027 -0.225 -0.422 -0.439 -0.85 -0.653 -1.278 -0.212 -0.426 -0.425 -0.851 -0.649 -1.271 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.215 -0.433 -0.435 -0.863 -0.663 -1.29 -0.24 -0.453 -0.467 -0.913 -0.695 -1.372 -0.17 -0.343 -0.346 -0.681 -0.537 -1.013C53.069 0.162 53.069 0.162 53.069 0" fill="#C1D789"></path><path d="M61.617 55.558c0.184 0.092 0.271 0.149 0.41 0.289l0.114 0.113 0.123 0.124 0.131 0.131q0.214 0.214 0.428 0.429l0.298 0.298q0.313 0.313 0.626 0.627a552.493 552.493 0 0 0 0.721 0.722q0.348 0.348 0.696 0.696 0.147 0.148 0.295 0.295 0.207 0.207 0.413 0.414l0.122 0.122 0.115 0.116 0.098 0.099c0.098 0.104 0.192 0.211 0.285 0.319 0.207 0.237 0.426 0.46 0.649 0.682l0.13 0.13q0.215 0.215 0.431 0.431l0.312 0.312q0.339 0.339 0.678 0.678 0.504 0.504 1.009 1.009 0.901 0.901 1.801 1.801 0.788 0.788 1.576 1.576l0.106 0.106 0.425 0.425q1.991 1.991 3.982 3.982 1.769 1.769 3.538 3.538a32609.273 32609.273 0 0 0 4.504 4.504q0.788 0.788 1.575 1.576a6750.88 6750.88 0 0 0 1.792 1.791q0.501 0.501 1.002 1.003 0.335 0.335 0.67 0.67 0.191 0.191 0.381 0.381 0.206 0.206 0.412 0.411l0.119 0.119c0.183 0.182 0.368 0.362 0.558 0.537l0.102 0.095c0.11 0.088 0.11 0.088 0.317 0.067 0.113 -0.081 0.113 -0.081 0.223 -0.196 0.044 -0.044 0.089 -0.088 0.134 -0.133l0.147 -0.149q0.079 -0.078 0.157 -0.157c0.145 -0.144 0.289 -0.29 0.434 -0.435 0.157 -0.158 0.314 -0.315 0.471 -0.472q0.414 -0.413 0.827 -0.828c0.409 -0.411 0.819 -0.821 1.229 -1.231a2622.355 2622.355 0 0 0 2.067 -2.07 3484.554 3484.554 0 0 1 2.048 -2.051l0.129 -0.129 0.646 -0.647a12869.473 12869.473 0 0 0 4.857 -4.862l0.139 -0.139 0.694 -0.696 0.139 -0.139q1.6 -1.602 3.199 -3.204l0.138 -0.139q1.564 -1.566 3.128 -3.131l0.133 -0.133 1.181 -1.182a7420.818 7420.818 0 0 0 2.95 -2.954q1.027 -1.029 2.055 -2.058 0.611 -0.612 1.222 -1.225a889.031 889.031 0 0 1 0.815 -0.816q0.233 -0.233 0.465 -0.466 0.211 -0.212 0.422 -0.423 0.113 -0.113 0.225 -0.226l0.134 -0.133 0.116 -0.116C123.179 55.558 123.179 55.558 123.287 55.558v36.137c-0.194 -0.097 -0.289 -0.167 -0.438 -0.317l-0.133 -0.133 -0.145 -0.146 -0.155 -0.155q-0.213 -0.213 -0.426 -0.427 -0.23 -0.23 -0.46 -0.46 -0.398 -0.398 -0.796 -0.797 -0.575 -0.576 -1.151 -1.152a4185.435 4185.435 0 0 1 -1.867 -1.869q-0.907 -0.908 -1.814 -1.816l-0.113 -0.113 -0.561 -0.561q-2.327 -2.329 -4.653 -4.659c-0.204 0.654 -0.283 1.358 0 2.002 0.555 0.867 1.476 1.548 2.249 2.214 0.471 0.406 0.931 0.824 1.387 1.247l0.218 0.202 0.11 0.101 0.11 0.102 0.111 0.102a222.177 222.177 0 0 0 1.247 1.145l0.115 0.105c0.533 0.485 1.073 0.96 1.619 1.429 0.947 0.814 1.871 1.649 2.766 2.52l0.106 0.102c2.054 1.997 3.057 3.761 3.107 6.666 0.016 1.782 -0.159 3.565 -0.431 5.324q-0.09 -0.076 -0.179 -0.153l-0.101 -0.086c-0.144 -0.126 -0.278 -0.259 -0.412 -0.395l-0.088 -0.088a136.595 136.595 0 0 1 -0.186 -0.187q-0.148 -0.149 -0.296 -0.297 -0.367 -0.368 -0.734 -0.737 -0.311 -0.312 -0.622 -0.624 -0.145 -0.145 -0.289 -0.291l-0.18 -0.181 -0.079 -0.08a8.439 8.439 0 0 0 -0.444 -0.413 30.565 30.565 0 0 1 -0.623 -0.56l-0.112 -0.103a323.879 323.879 0 0 1 -0.499 -0.461c-0.829 -0.767 -1.648 -1.545 -2.462 -2.329a506.024 506.024 0 0 0 -0.482 -0.463c-0.427 -0.41 -0.86 -0.811 -1.297 -1.21a52.041 52.041 0 0 1 -1.333 -1.264c-0.245 -0.239 -0.491 -0.474 -0.748 -0.701 -0.988 -0.875 -1.684 -1.678 -1.779 -3.023 -0.062 -1.078 -0.014 -2.159 0.07 -3.234l-0.115 0.115c-1.665 1.67 -3.331 3.34 -4.998 5.009l-0.076 0.076a20882.762 20882.762 0 0 1 -2.45 2.453l-0.081 0.081a4796.678 4796.678 0 0 0 -2.601 2.607 3471.029 3471.029 0 0 1 -2.748 2.753 1408.2 1408.2 0 0 0 -1.647 1.65q-0.563 0.566 -1.128 1.13a248.305 248.305 0 0 0 -0.652 0.653 149.795 149.795 0 0 1 -0.596 0.596 46.145 46.145 0 0 0 -0.216 0.217 38.896 38.896 0 0 1 -0.293 0.292l-0.085 0.087c-0.187 0.183 -0.187 0.183 -0.329 0.193 -0.161 -0.092 -0.284 -0.216 -0.414 -0.347l-0.092 -0.092c-0.102 -0.102 -0.204 -0.205 -0.306 -0.307l-0.221 -0.221c-0.203 -0.203 -0.406 -0.407 -0.609 -0.61 -0.219 -0.219 -0.438 -0.438 -0.657 -0.657a1226.11 1226.11 0 0 1 -1.138 -1.139 2295.392 2295.392 0 0 0 -1.645 -1.647q-1.335 -1.336 -2.669 -2.672a7943.558 7943.558 0 0 0 -2.756 -2.76l-1.262 -1.263c-2.064 -2.065 -4.127 -4.132 -6.19 -6.198l-0.054 18.988h-12.767z" fill="#98BD3A"></path><path d="M42.466 61.887h12.821c0.153 5.21 0.153 5.21 0.185 7.411q0.011 0.755 0.023 1.511l0.003 0.191c0.016 1.01 0.046 2.018 0.081 3.027a115.281 115.281 0 0 1 0.064 3.123c0.005 0.583 0.016 1.165 0.044 1.747 0.102 2.141 0.13 3.974 -1.377 5.636 -0.772 0.828 -1.63 1.578 -2.52 2.277 -0.404 0.317 -0.779 0.658 -1.14 1.022l-0.121 0.121q-0.2 0.2 -0.399 0.4l-0.29 0.29q-0.315 0.315 -0.629 0.631 -0.468 0.469 -0.936 0.938 -0.739 0.74 -1.478 1.481 -1.172 1.175 -2.345 2.349l-0.499 0.5 -0.606 0.607 -2.284 2.287 -0.105 0.105a10187.936 10187.936 0 0 0 -3.387 3.394 5815.109 5815.109 0 0 1 -3.975 3.98l-0.098 0.098q-0.78 0.78 -1.558 1.562a1175.475 1175.475 0 0 1 -1.565 1.567 445.814 445.814 0 0 0 -0.93 0.932 231.752 231.752 0 0 1 -0.694 0.694 78.224 78.224 0 0 0 -0.281 0.282 65.836 65.836 0 0 1 -0.381 0.381l-0.112 0.114 -0.103 0.101 -0.088 0.088c-0.088 0.055 -0.088 0.055 -0.195 0.047 -0.131 -0.056 -0.21 -0.122 -0.313 -0.22l-0.121 -0.113 -0.132 -0.126 -0.141 -0.133a129.292 129.292 0 0 1 -0.389 -0.369q-0.168 -0.159 -0.336 -0.318a482.275 482.275 0 0 1 -1.026 -0.972q-0.3 -0.285 -0.6 -0.569a611.08 611.08 0 0 1 -4.932 -4.728l-0.117 -0.114a1300.872 1300.872 0 0 1 -2.523 -2.454 2267.695 2267.695 0 0 0 -1.237 -1.205l-0.124 -0.121c-1.32 -1.285 -2.653 -2.555 -3.994 -3.817 -1.384 -1.303 -2.752 -2.619 -4.104 -3.955q-0.289 -0.286 -0.579 -0.571l-0.115 -0.113a64.538 64.538 0 0 0 -1.61 -1.529c-0.918 -0.843 -1.816 -1.703 -2.678 -2.604 -0.032 -0.034 -0.065 -0.068 -0.098 -0.103 -2.139 -2.237 -2.875 -4.287 -2.821 -7.385 0.036 -1.546 0.178 -3.083 0.4 -4.612 0.212 0.179 0.42 0.36 0.617 0.556l0.132 0.132 0.141 0.142 0.153 0.153q0.209 0.209 0.417 0.418 0.226 0.226 0.451 0.451 0.391 0.391 0.781 0.781a3228.566 3228.566 0 0 0 1.129 1.13q0.916 0.916 1.832 1.833 0.889 0.89 1.779 1.78l0.111 0.111 0.551 0.551Q10.377 84.975 12.659 87.259c0.205 -0.637 0.28 -1.321 0 -1.947 -0.556 -0.859 -1.471 -1.535 -2.239 -2.197 -0.469 -0.404 -0.927 -0.82 -1.381 -1.241a1190.622 1190.622 0 0 0 -0.546 -0.505 227.695 227.695 0 0 0 -1.242 -1.14l-0.115 -0.105c-0.53 -0.483 -1.068 -0.956 -1.613 -1.423 -0.943 -0.81 -1.863 -1.64 -2.754 -2.508l-0.105 -0.102c-2.056 -2 -3.044 -3.771 -3.094 -6.678 -0.016 -1.794 0.158 -3.59 0.43 -5.362 0.299 0.249 0.576 0.514 0.85 0.789l0.141 0.14q0.193 0.192 0.385 0.385 0.21 0.21 0.419 0.419 0.367 0.367 0.734 0.734 0.546 0.546 1.092 1.092 0.919 0.919 1.837 1.837 0.909 0.91 1.819 1.819l0.114 0.114 0.574 0.574q2.034 2.034 4.068 4.069a55053.33 55053.33 0 0 0 5.298 5.299l2.492 2.492 0.116 0.116Q23.764 87.76 27.589 91.586l0.073 -0.063a29.321 29.321 0 0 1 0.577 -0.485c2.344 -1.917 4.62 -3.906 6.84 -5.965q0.195 -0.18 0.389 -0.361c3.968 -3.675 7.661 -7.169 7.964 -13.092 0.036 -1.06 -0.016 -2.114 -0.092 -3.171l-0.018 -0.252a72.328 72.328 0 0 0 -0.144 -1.733l-0.01 -0.111c-0.142 -1.508 -0.435 -2.972 -0.704 -4.466" fill="#98BD3A"></path><path d="M148.713 61.887h55.287c-0.087 0.175 -0.161 0.292 -0.283 0.44l-0.11 0.134 -0.121 0.147 -0.129 0.157a146.333 146.333 0 0 1 -0.509 0.612c-1.407 1.685 -2.868 3.321 -4.362 4.929a394.313 394.313 0 0 0 -0.316 0.34c-6.054 6.524 -6.054 6.524 -10.563 6.898l-0.208 0.018c-2.956 0.246 -6.003 -0.45 -8.88 -0.855v16.986c-0.188 -0.094 -0.291 -0.166 -0.44 -0.306l-0.134 -0.126 -0.147 -0.139 -0.157 -0.147a182.469 182.469 0 0 1 -0.43 -0.406q-0.137 -0.13 -0.275 -0.26c-1.166 -1.101 -2.32 -2.214 -3.47 -3.333q-0.283 -0.275 -0.566 -0.551l-0.114 -0.111c-0.604 -0.586 -1.215 -1.165 -1.83 -1.74a100.404 100.404 0 0 1 -1.877 -1.806c-0.346 -0.341 -0.695 -0.678 -1.055 -1.006q-0.156 -0.144 -0.312 -0.289a13.524 13.524 0 0 0 -0.191 -0.172c-0.765 -0.675 -1.219 -1.462 -1.824 -2.322v-4.274h-16.986z" fill="#98BD3A"></path><path d="M53.069 0c0.147 0.098 0.198 0.146 0.294 0.284 0.234 0.321 0.498 0.617 0.758 0.917 0.128 0.149 0.255 0.299 0.381 0.449 0.206 0.244 0.414 0.488 0.622 0.73q0.349 0.407 0.695 0.817c0.184 0.218 0.37 0.434 0.556 0.65 0.189 0.22 0.375 0.441 0.558 0.666 0.279 0.343 0.57 0.676 0.86 1.009 0.336 0.386 0.67 0.774 0.993 1.172 0.192 0.237 0.394 0.463 0.599 0.689 0.163 0.184 0.317 0.375 0.472 0.566 0.159 0.193 0.323 0.382 0.488 0.571 0.207 0.237 0.411 0.476 0.609 0.72A12.496 12.496 0 0 0 61.427 9.792c0.207 0.227 0.401 0.462 0.594 0.701 0.159 0.193 0.323 0.382 0.488 0.571 0.202 0.232 0.402 0.464 0.595 0.703 0.278 0.343 0.568 0.674 0.857 1.006 0.373 0.43 0.742 0.863 1.109 1.298 0.184 0.218 0.37 0.434 0.556 0.65 0.189 0.22 0.375 0.441 0.558 0.666 0.279 0.343 0.57 0.676 0.861 1.01 0.373 0.43 0.742 0.863 1.109 1.298 0.184 0.218 0.37 0.434 0.556 0.65a29.807 29.807 0 0 1 0.571 0.683c0.192 0.237 0.394 0.463 0.599 0.689 0.163 0.184 0.317 0.375 0.472 0.566 0.159 0.193 0.323 0.382 0.488 0.571 0.202 0.232 0.402 0.464 0.595 0.703 0.278 0.343 0.568 0.674 0.857 1.006 0.373 0.43 0.742 0.863 1.109 1.298 0.184 0.218 0.37 0.434 0.556 0.65 0.189 0.22 0.375 0.441 0.558 0.666 0.279 0.343 0.57 0.676 0.861 1.01 0.373 0.43 0.742 0.863 1.109 1.298 0.184 0.218 0.37 0.434 0.556 0.65 0.189 0.22 0.375 0.441 0.558 0.666 0.279 0.343 0.57 0.676 0.861 1.01 0.373 0.43 0.742 0.863 1.109 1.298 0.184 0.218 0.37 0.434 0.556 0.65a29.807 29.807 0 0 1 0.571 0.683c0.192 0.237 0.394 0.463 0.599 0.689 0.163 0.184 0.317 0.375 0.472 0.566 0.159 0.193 0.323 0.382 0.488 0.571 0.202 0.232 0.402 0.464 0.595 0.703 0.277 0.342 0.567 0.672 0.855 1.004q0.227 0.262 0.453 0.524l0.083 0.096c0.222 0.259 0.329 0.437 0.394 0.773l0.021 0.109c0.046 0.24 0.082 0.481 0.114 0.723 0.039 0.289 0.099 0.566 0.173 0.848 0.102 0.405 0.195 0.819 0.232 1.235 0.023 0.242 0.084 0.469 0.145 0.704 0.114 0.455 0.199 0.914 0.261 1.379 0.039 0.29 0.099 0.566 0.174 0.849 0.114 0.451 0.198 0.908 0.259 1.369 0.039 0.29 0.099 0.566 0.174 0.849 0.114 0.451 0.198 0.908 0.259 1.369 0.039 0.29 0.099 0.566 0.174 0.849 0.114 0.451 0.198 0.908 0.259 1.369 0.039 0.289 0.099 0.566 0.173 0.848 0.102 0.405 0.195 0.819 0.232 1.235 0.023 0.242 0.084 0.469 0.145 0.704 0.114 0.455 0.199 0.914 0.261 1.379 0.039 0.29 0.099 0.566 0.174 0.849 0.114 0.451 0.198 0.908 0.259 1.369 0.039 0.29 0.099 0.566 0.174 0.849 0.114 0.451 0.198 0.908 0.259 1.369 0.039 0.29 0.099 0.566 0.174 0.849 0.114 0.451 0.198 0.908 0.259 1.369 0.039 0.29 0.099 0.566 0.174 0.849 0.114 0.451 0.198 0.908 0.259 1.369 0.039 0.289 0.099 0.566 0.173 0.848 0.102 0.405 0.195 0.819 0.232 1.235 0.023 0.242 0.084 0.469 0.145 0.704 0.114 0.455 0.199 0.914 0.261 1.379 0.039 0.29 0.099 0.566 0.174 0.849 0.114 0.451 0.198 0.908 0.259 1.369 0.039 0.29 0.099 0.566 0.174 0.849 0.114 0.451 0.198 0.908 0.259 1.369 0.039 0.29 0.099 0.566 0.174 0.849 0.128 0.506 0.217 1.019 0.279 1.537 0.028 0.168 0.065 0.325 0.108 0.49 0.11 0.428 0.18 0.862 0.254 1.297q0.031 0.184 0.063 0.369 0.02 0.114 0.039 0.227c0.04 0.234 0.099 0.458 0.166 0.685 0.012 0.147 0.005 0.285 0 0.433h-0.108l-0.096 -0.192q-0.18 -0.361 -0.36 -0.722l-0.154 -0.309c-0.287 -0.576 -0.577 -1.149 -0.878 -1.718 -0.195 -0.369 -0.382 -0.741 -0.567 -1.116 -0.212 -0.426 -0.425 -0.851 -0.649 -1.271 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.911 -0.699 -1.371 -0.217 -0.436 -0.438 -0.869 -0.667 -1.298 -0.223 -0.421 -0.434 -0.848 -0.646 -1.274 -0.172 -0.345 -0.347 -0.687 -0.528 -1.027 -0.225 -0.422 -0.439 -0.85 -0.653 -1.278 -0.212 -0.426 -0.425 -0.851 -0.649 -1.271 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.911 -0.699 -1.371 -0.217 -0.436 -0.438 -0.869 -0.667 -1.298 -0.223 -0.421 -0.434 -0.848 -0.646 -1.274 -0.172 -0.345 -0.347 -0.687 -0.528 -1.027 -0.225 -0.422 -0.439 -0.85 -0.653 -1.278 -0.212 -0.426 -0.425 -0.851 -0.649 -1.271 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.195 -0.393 -0.393 -0.784 -0.6 -1.172 -0.241 -0.453 -0.47 -0.912 -0.699 -1.371 -0.215 -0.433 -0.435 -0.863 -0.663 -1.29 -0.24 -0.453 -0.467 -0.913 -0.695 -1.372 -0.17 -0.343 -0.346 -0.681 -0.537 -1.013C53.069 0.162 53.069 0.162 53.069 0" fill="#023E7E"></path><path d="m131.564 0 0.162 0.054 -0.098 0.187c-0.391 0.744 -0.774 1.492 -1.156 2.241a562.826 562.826 0 0 1 -1.109 2.164A801.015 801.015 0 0 0 128.372 6.573a888.274 888.274 0 0 1 -1.001 1.947 967.959 967.959 0 0 0 -1.066 2.075 1404.738 1404.738 0 0 1 -1.022 1.99 1348.153 1348.153 0 0 0 -0.972 1.892 958.654 958.654 0 0 1 -1.053 2.049 931.984 931.984 0 0 0 -1.011 1.967A1325.27 1325.27 0 0 1 121.286 20.368a1455.211 1455.211 0 0 0 -1.028 2.002 1531.812 1531.812 0 0 1 -1.088 2.118 1347.882 1347.882 0 0 0 -0.972 1.892 958.654 958.654 0 0 1 -1.053 2.049 931.984 931.984 0 0 0 -1.011 1.967A1325.27 1325.27 0 0 1 115.173 32.269a1459.376 1459.376 0 0 0 -1.028 2.002q-0.517 1.008 -1.035 2.015l-0.06 0.117 -0.9 1.749 -0.06 0.117a1649.636 1649.636 0 0 0 -1.043 2.032 1459.484 1459.484 0 0 1 -1.019 1.984A1396.299 1396.299 0 0 0 109.06 44.17q-0.517 1.008 -1.035 2.015l-0.06 0.117 -0.9 1.749 -0.06 0.117a1649.636 1649.636 0 0 0 -1.043 2.032 1459.484 1459.484 0 0 1 -1.019 1.984A1396.299 1396.299 0 0 0 103.975 54.07q-0.517 1.008 -1.035 2.015l-0.06 0.117 -0.9 1.749 -0.06 0.117a1649.636 1649.636 0 0 0 -1.043 2.032 1459.484 1459.484 0 0 1 -1.019 1.984A1396.299 1396.299 0 0 0 98.889 63.97q-0.517 1.008 -1.035 2.015l-0.06 0.117 -0.9 1.749 -0.06 0.117a1649.636 1649.636 0 0 0 -1.043 2.032 1428.811 1428.811 0 0 1 -1.019 1.983 1173.473 1173.473 0 0 0 -0.909 1.771A635.586 635.586 0 0 1 92.452 76.493h-0.108c-0.009 -0.272 0.02 -0.498 0.091 -0.761q0.03 -0.114 0.06 -0.229l0.032 -0.124c0.161 -0.635 0.301 -1.274 0.41 -1.919 0.176 -1.037 0.176 -1.037 0.272 -1.133 0.027 -0.138 0.051 -0.277 0.074 -0.416 0.208 -1.219 0.208 -1.219 0.304 -1.315 0.027 -0.138 0.051 -0.277 0.074 -0.416 0.208 -1.219 0.208 -1.219 0.304 -1.315 0.027 -0.138 0.051 -0.277 0.074 -0.416 0.208 -1.219 0.208 -1.219 0.304 -1.315 0.024 -0.125 0.045 -0.25 0.066 -0.375 0.111 -0.654 0.257 -1.3 0.399 -1.947l0.091 -0.419q0.111 -0.508 0.222 -1.015 0.131 -0.598 0.262 -1.196c0.202 -0.927 0.405 -1.854 0.608 -2.781l0.273 -1.247a12071.65 12071.65 0 0 1 1.059 -4.836l0.024 -0.111a1743.656 1743.656 0 0 0 0.753 -3.453l0.072 -0.332 0.035 -0.161q0.1 -0.458 0.199 -0.916 0.059 -0.272 0.118 -0.544l0.054 -0.248q0.036 -0.166 0.072 -0.331l0.04 -0.185C98.727 46.902 98.727 46.902 98.781 46.848c0.027 -0.138 0.051 -0.277 0.074 -0.416 0.208 -1.219 0.208 -1.219 0.304 -1.315 0.027 -0.138 0.051 -0.277 0.074 -0.416 0.208 -1.219 0.208 -1.219 0.304 -1.315 0.027 -0.138 0.051 -0.277 0.074 -0.416 0.208 -1.219 0.208 -1.219 0.304 -1.315 0.027 -0.138 0.051 -0.277 0.074 -0.416 0.208 -1.219 0.208 -1.219 0.304 -1.315 0.026 -0.133 0.049 -0.265 0.071 -0.399q0.022 -0.126 0.045 -0.252c0.032 -0.18 0.061 -0.359 0.088 -0.54 0.08 -0.482 0.156 -0.82 0.524 -1.166 0.162 -0.155 0.293 -0.323 0.429 -0.5A18.934 18.934 0 0 1 102.054 36.326a19.745 19.745 0 0 0 0.595 -0.73c0.216 -0.279 0.44 -0.549 0.669 -0.817 0.179 -0.21 0.351 -0.425 0.521 -0.643 0.216 -0.279 0.44 -0.549 0.669 -0.817 0.179 -0.21 0.351 -0.425 0.521 -0.643 0.216 -0.279 0.44 -0.549 0.669 -0.817 0.179 -0.21 0.351 -0.425 0.521 -0.643 0.216 -0.279 0.44 -0.549 0.669 -0.817 0.179 -0.21 0.351 -0.425 0.521 -0.643 0.216 -0.279 0.44 -0.549 0.669 -0.817 0.179 -0.21 0.351 -0.425 0.521 -0.643 0.216 -0.279 0.44 -0.549 0.669 -0.817 0.179 -0.21 0.351 -0.425 0.521 -0.643 0.216 -0.279 0.44 -0.549 0.669 -0.817 0.179 -0.21 0.351 -0.425 0.521 -0.643 0.216 -0.279 0.44 -0.549 0.669 -0.817 0.179 -0.21 0.351 -0.425 0.521 -0.643 0.216 -0.279 0.44 -0.549 0.669 -0.817 0.179 -0.21 0.351 -0.425 0.521 -0.643 0.216 -0.279 0.44 -0.549 0.669 -0.817 0.179 -0.21 0.351 -0.425 0.521 -0.643 0.216 -0.279 0.44 -0.549 0.669 -0.817 0.179 -0.21 0.351 -0.425 0.521 -0.643 0.216 -0.279 0.44 -0.549 0.669 -0.817 0.179 -0.21 0.351 -0.425 0.521 -0.643 0.216 -0.279 0.44 -0.549 0.669 -0.817 0.179 -0.21 0.351 -0.425 0.521 -0.643 0.216 -0.279 0.44 -0.549 0.669 -0.817 0.179 -0.21 0.351 -0.425 0.521 -0.643 0.216 -0.279 0.44 -0.549 0.669 -0.817 0.179 -0.21 0.351 -0.425 0.521 -0.643 0.216 -0.279 0.44 -0.549 0.669 -0.817 0.179 -0.21 0.351 -0.425 0.521 -0.643 0.216 -0.279 0.44 -0.549 0.669 -0.817 0.179 -0.21 0.351 -0.425 0.521 -0.643 0.216 -0.279 0.44 -0.549 0.669 -0.817 0.179 -0.21 0.351 -0.425 0.521 -0.643 0.216 -0.279 0.44 -0.549 0.669 -0.817 0.179 -0.21 0.351 -0.425 0.521 -0.643 0.216 -0.279 0.44 -0.549 0.669 -0.817 0.179 -0.21 0.351 -0.425 0.521 -0.643 0.216 -0.279 0.44 -0.549 0.669 -0.817 0.179 -0.21 0.351 -0.425 0.521 -0.643 0.216 -0.279 0.44 -0.549 0.669 -0.817 0.179 -0.21 0.351 -0.425 0.521 -0.643 0.216 -0.279 0.44 -0.549 0.669 -0.817 0.205 -0.241 0.401 -0.489 0.595 -0.739 0.171 -0.219 0.347 -0.431 0.528 -0.642 0.342 -0.399 0.676 -0.809 0.94 -1.265" fill="#023F7E"></path><path d="M129.617 61.887h12.767v29.807l-0.379 -0.325a12.767 12.767 0 0 0 -0.24 -0.186l-0.133 -0.101 -0.143 -0.108c-1.932 -1.471 -3.788 -3.024 -5.59 -4.651a303.106 303.106 0 0 0 -0.334 -0.301c-3.774 -3.4 -6.504 -6.579 -6.777 -11.818 -0.074 -1.518 -0.03 -3.03 0.055 -4.546l0.016 -0.294a116.796 116.796 0 0 1 0.129 -2.028l0.009 -0.13c0.129 -1.785 0.386 -3.544 0.62 -5.321" fill="#98BD3A"></path><path d="M165.699 81.037c0.171 0.077 0.299 0.171 0.44 0.294l0.134 0.118 0.147 0.13 0.157 0.138q0.215 0.19 0.43 0.381l0.275 0.244c1.176 1.043 2.327 2.112 3.47 3.191a472.105 472.105 0 0 0 0.566 0.534l0.114 0.107a57.83 57.83 0 0 0 1.602 1.449c0.938 0.818 1.855 1.656 2.738 2.534l0.104 0.104c2.083 2.072 3.046 3.914 3.073 6.885 0.002 1.743 -0.166 3.485 -0.428 5.206 -1.766 -1.507 -3.477 -3.078 -5.166 -4.671a450.628 450.628 0 0 0 -0.558 -0.525l-0.112 -0.105a56.856 56.856 0 0 0 -1.578 -1.425c-0.925 -0.806 -1.828 -1.631 -2.699 -2.496l-0.103 -0.102c-2.061 -2.049 -3.001 -3.875 -3.027 -6.813 -0.002 -1.733 0.163 -3.465 0.422 -5.177" fill="#013D7E"></path><path d="M129.617 81.037c1.758 1.5 3.463 3.062 5.145 4.647a443.434 443.434 0 0 0 0.555 0.522l0.112 0.105a55.882 55.882 0 0 0 1.571 1.417c0.922 0.801 1.821 1.622 2.687 2.483l0.103 0.102c2.064 2.052 2.988 3.884 3.014 6.824 0.002 1.745 -0.163 3.49 -0.42 5.215 -1.758 -1.5 -3.463 -3.062 -5.145 -4.647a443.434 443.434 0 0 0 -0.555 -0.522l-0.112 -0.105a55.882 55.882 0 0 0 -1.571 -1.417c-0.922 -0.801 -1.821 -1.622 -2.687 -2.483l-0.103 -0.102c-2.064 -2.052 -2.988 -3.884 -3.014 -6.824 -0.002 -1.745 0.163 -3.49 0.42 -5.215" fill="#013D7E"></path><path d="M110.466 95.914c0.179 0.078 0.3 0.177 0.44 0.312l0.134 0.13 0.147 0.143 0.157 0.152a200.862 200.862 0 0 1 0.43 0.418q0.137 0.134 0.275 0.267c1.2 1.165 2.392 2.338 3.582 3.513l0.453 0.447 0.114 0.112c0.607 0.598 1.217 1.193 1.83 1.785a203.621 203.621 0 0 1 1.877 1.842c0.349 0.346 0.699 0.691 1.055 1.03 2.482 2.376 2.482 2.376 2.513 3.535 -0.011 0.408 -0.073 0.798 -0.186 1.189 -0.219 -0.087 -0.366 -0.243 -0.529 -0.408l-0.094 -0.094c-0.104 -0.104 -0.208 -0.208 -0.311 -0.313l-0.223 -0.224q-0.241 -0.241 -0.481 -0.482c-0.253 -0.255 -0.507 -0.509 -0.761 -0.763q-0.603 -0.604 -1.205 -1.208a3760.665 3760.665 0 0 0 -2.155 -2.161q-0.378 -0.379 -0.756 -0.758 -0.236 -0.236 -0.472 -0.473l-0.218 -0.219c-0.474 -0.478 -0.474 -0.478 -0.973 -0.928 -0.193 -0.165 -0.378 -0.338 -0.565 -0.509l-0.134 -0.124c-0.408 -0.377 -0.811 -0.76 -1.212 -1.145 -0.268 -0.258 -0.538 -0.513 -0.813 -0.763 -2.001 -1.821 -2.001 -1.821 -2.068 -2.889 -0.009 -0.479 0.049 -0.949 0.15 -1.417" fill="#013D7D"></path><path d="M165.699 95.914c0.179 0.078 0.3 0.177 0.44 0.312l0.134 0.13 0.147 0.143 0.157 0.152a200.862 200.862 0 0 1 0.43 0.418q0.137 0.134 0.275 0.267c1.2 1.165 2.392 2.338 3.582 3.513l0.453 0.447 0.114 0.112c0.607 0.598 1.217 1.193 1.83 1.785a203.621 203.621 0 0 1 1.877 1.842c0.349 0.346 0.699 0.691 1.055 1.03 2.482 2.376 2.482 2.376 2.513 3.535 -0.011 0.408 -0.073 0.798 -0.186 1.189 -0.179 -0.078 -0.3 -0.177 -0.44 -0.312l-0.134 -0.13 -0.147 -0.143 -0.157 -0.152a200.862 200.862 0 0 1 -0.43 -0.418 262.046 262.046 0 0 0 -0.275 -0.267c-1.2 -1.165 -2.392 -2.338 -3.582 -3.513l-0.453 -0.447 -0.114 -0.112c-0.607 -0.598 -1.217 -1.193 -1.83 -1.785a203.621 203.621 0 0 1 -1.877 -1.842c-0.349 -0.346 -0.699 -0.691 -1.055 -1.03 -2.482 -2.376 -2.482 -2.376 -2.513 -3.535 0.011 -0.408 0.073 -0.798 0.186 -1.189" fill="#013D7E"></path><path d="M0 55.558c0.311 0.26 0.604 0.536 0.895 0.819l0.154 0.149q0.211 0.204 0.421 0.409 0.135 0.131 0.27 0.262c1.14 1.106 2.274 2.219 3.405 3.334a1932.347 1932.347 0 0 0 0.667 0.657c0.595 0.586 1.194 1.168 1.795 1.749a191.504 191.504 0 0 1 1.843 1.806c0.342 0.34 0.686 0.677 1.035 1.009 2.434 2.323 2.434 2.323 2.465 3.51 -0.01 0.42 -0.072 0.823 -0.182 1.227 -0.311 -0.26 -0.604 -0.536 -0.895 -0.819l-0.154 -0.149a396.207 396.207 0 0 1 -0.421 -0.409l-0.27 -0.262c-1.14 -1.106 -2.274 -2.219 -3.405 -3.334a1932.347 1932.347 0 0 0 -0.667 -0.657c-0.595 -0.586 -1.194 -1.168 -1.795 -1.749a191.504 191.504 0 0 1 -1.843 -1.806c-0.342 -0.34 -0.686 -0.677 -1.035 -1.009 -2.434 -2.323 -2.434 -2.323 -2.465 -3.51 0.01 -0.42 0.072 -0.823 0.182 -1.227" fill="#013D7E"></path><path d="M129.617 95.914c0.311 0.26 0.604 0.537 0.895 0.819l0.154 0.15q0.211 0.204 0.421 0.409 0.135 0.131 0.27 0.262c1.14 1.107 2.274 2.22 3.405 3.336a1985.2 1985.2 0 0 0 0.667 0.657c0.595 0.586 1.194 1.169 1.795 1.75a196.426 196.426 0 0 1 1.843 1.807c0.342 0.34 0.686 0.677 1.035 1.01 2.434 2.326 2.434 2.326 2.465 3.484 -0.01 0.408 -0.072 0.8 -0.182 1.193 -0.178 -0.078 -0.3 -0.176 -0.439 -0.311l-0.134 -0.129 -0.146 -0.142 -0.156 -0.151q-0.214 -0.208 -0.428 -0.416 -0.137 -0.133 -0.274 -0.266c-1.195 -1.16 -2.382 -2.327 -3.567 -3.496l-0.565 -0.557c-0.604 -0.595 -1.212 -1.187 -1.822 -1.776a196.805 196.805 0 0 1 -1.869 -1.833c-0.347 -0.345 -0.696 -0.687 -1.05 -1.025 -2.471 -2.362 -2.471 -2.362 -2.502 -3.549 0.011 -0.419 0.073 -0.821 0.185 -1.224" fill="#013D7E"></path><path d="M92.722 74.113h0.108q-0.025 0.154 -0.051 0.308l-0.029 0.173c-0.025 0.147 -0.053 0.293 -0.083 0.439l-0.108 -0.054c0.006 -0.094 0.013 -0.187 0.02 -0.281 0.004 -0.052 0.008 -0.104 0.011 -0.158 0.023 -0.157 0.066 -0.283 0.131 -0.427" fill="#88AF42"></path><path d="m131.564 0 0.162 0.054 -0.433 0.811 -0.054 -0.162 0.054 -0.108 -0.108 -0.054 0.098 -0.118C131.39 0.286 131.478 0.15 131.564 0" fill="#51825A"></path><path d="m92.29 76.331 0.108 0.162c-0.047 0.145 -0.047 0.145 -0.108 0.27h-0.108c-0.034 -0.098 -0.034 -0.098 -0.054 -0.216 0.108 -0.162 0.108 -0.162 0.162 -0.216" fill="#658F5C"></path><path d="M53.069 0c0.188 0.126 0.232 0.231 0.325 0.433l-0.108 0.162a22.613 22.613 0 0 1 -0.108 -0.206l-0.061 -0.116C53.069 0.162 53.069 0.162 53.069 0" fill="#46755B"></path><path d="m131.564 0 0.162 0.054 -0.216 0.379 -0.108 -0.162z" fill="#779B3A"></path></svg>


<p><a class=enrollment href="mdm/enroll">Enroll a device</a></p>

</body>
</html>

`

func serve(args []string) error {
	flagset := flag.NewFlagSet("serve", flag.ExitOnError)
	var (
		flConfigPath             = flagset.String("config-path", env.String("MICROMDM_CONFIG_PATH", "/var/db/micromdm"), "Path to configuration directory")
		flServerURL              = flagset.String("server-url", env.String("MICROMDM_SERVER_URL", ""), "Public HTTPS url of your server")
		flAPIKey                 = flagset.String("api-key", env.String("MICROMDM_API_KEY", ""), "API Token for mdmctl command")
		flTLS                    = flagset.Bool("tls", env.Bool("MICROMDM_TLS", true), "Use https")
		flTLSCert                = flagset.String("tls-cert", env.String("MICROMDM_TLS_CERT", ""), "Path to TLS certificate")
		flTLSKey                 = flagset.String("tls-key", env.String("MICROMDM_TLS_KEY", ""), "Path to TLS private key")
		flHTTPAddr               = flagset.String("http-addr", env.String("MICROMDM_HTTP_ADDR", ":https"), "http(s) listen address of mdm server. defaults to :8080 if tls is false")
		flHTTPDebug              = flagset.Bool("http-debug", env.Bool("MICROMDM_HTTP_DEBUG", false), "Enable debug for http(dumps full request)")
		flHTTPProxyHeaders       = flagset.Bool("http-proxy-headers", env.Bool("MICROMDM_HTTP_PROXY_HEADERS", false), "Enable parsing of proxy headers for use behind a reverse proxy")
		flRepoPath               = flagset.String("filerepo", env.String("MICROMDM_FILE_REPO", ""), "Path to http file repo")
		flDepSim                 = flagset.String("depsim", env.String("MICROMDM_DEPSIM_URL", ""), "Use depsim URL")
		flExamples               = flagset.Bool("examples", false, "Prints some example usage")
		flCommandWebhookURL      = flagset.String("command-webhook-url", env.String("MICROMDM_WEBHOOK_URL", ""), "URL to send command responses")
		flHomePage               = flagset.Bool("homepage", env.Bool("MICROMDM_HTTP_HOMEPAGE", true), "Hosts a simple built-in webpage at the / address")
		flSCEPClientValidity     = flagset.Int("scep-client-validity", env.Int("MICROMDM_SCEP_CLIENT_VALIDITY", 365), "Sets the scep certificate validity in days")
		flNoCmdHistory           = flagset.Bool("no-command-history", env.Bool("MICROMDM_NO_COMMAND_HISTORY", false), "disables saving of command history")
		flUseDynChallenge        = flagset.Bool("use-dynamic-challenge", env.Bool("MICROMDM_USE_DYNAMIC_CHALLENGE", false), "require dynamic SCEP challenges")
		flGenDynChalEnroll       = flagset.Bool("gen-dynamic-challenge", env.Bool("MICROMDM_GEN_DYNAMIC_CHALLENGE", false), "generate dynamic SCEP challenges in enrollment profile (built-in only)")
		flValidateSCEPIssuer     = flagset.Bool("validate-scep-issuer", env.Bool("MICROMDM_VALIDATE_SCEP_ISSUER", false), "validate only the issuer of the SCEP certificate rather than the whole certificate")
		flUDIDCertAuthWarnOnly   = flagset.Bool("udid-cert-auth-warn-only", env.Bool("MICROMDM_UDID_CERT_AUTH_WARN_ONLY", false), "warn only for udid cert mismatches")
		flValidateSCEPExpiration = flagset.Bool("validate-scep-expiration", env.Bool("MICROMDM_VALIDATE_SCEP_EXPIRATION", false), "validate that the SCEP certificate is still valid")
		flPrintArgs              = flagset.Bool("print-flags", false, "Print all flags and their values")
		flQueue                  = flagset.String("queue", env.String("MICROMDM_QUEUE", "builtin"), "command queue type")
		flDMURL                  = flagset.String("dm", env.String("DM", ""), "URL to send Declarative Management requests to")
		flLogTime                = flagset.Bool("log-time", false, "Include timestamp in log messages")
		flP7Skew                 = flagset.Int("device-signature-skew", env.Int("MICROMDM_DEVICE_SIGNATURE_SKEW", 0), "Sets the allowable clock skew (in seconds) when verifying device signatures")
		flDisableRedirect        = flagset.Bool("disable-redirect", env.Bool("MICROMDM_DISABLE_REDIRECT", false), "disable the :80 -> :443 redirect if listening on :443")
	)
	flagset.Usage = usageFor(flagset, "micromdm serve [flags]")
	if err := flagset.Parse(args); err != nil {
		return err
	}

	if *flPrintArgs {
		flagset.VisitAll(func(fl *flag.Flag) {
			fmt.Printf("%v: %v\n", fl.Usage, fl.Value)
		})
	}

	if *flExamples {
		printExamples()
		return nil
	}

	if *flServerURL == "" {
		return errors.New("must supply -server-url")
	}
	if !strings.HasPrefix(*flServerURL, "https://") {
		return errors.New("-server-url must begin with https://")
	}
	if !*flTLS && (*flTLSCert != "" || *flTLSKey != "") {
		return errors.New("cannot set -tls=false and supply -tls-cert or -tls-key")
	}

	logger := log.NewLogfmtLogger(os.Stderr)
	if *flLogTime {
		logger = log.With(logger, "ts", log.DefaultTimestampUTC)
	}
	stdlog.SetOutput(log.NewStdlibAdapter(logger)) // force structured logs
	mainLogger := log.With(logger, "component", "main")
	mainLogger.Log("msg", "started")

	if err := os.MkdirAll(*flConfigPath, 0755); err != nil {
		return errors.Wrapf(err, "creating config directory %s", *flConfigPath)
	}
	sm := &server.Server{
		ConfigPath:             *flConfigPath,
		ServerPublicURL:        strings.TrimRight(*flServerURL, "/"),
		Depsim:                 *flDepSim,
		TLSCertPath:            *flTLSCert,
		CommandWebhookURL:      *flCommandWebhookURL,
		NoCmdHistory:           *flNoCmdHistory,
		UseDynSCEPChallenge:    *flUseDynChallenge,
		GenDynSCEPChallenge:    *flGenDynChalEnroll,
		ValidateSCEPIssuer:     *flValidateSCEPIssuer,
		UDIDCertAuthWarnOnly:   *flUDIDCertAuthWarnOnly,
		ValidateSCEPExpiration: *flValidateSCEPExpiration,

		WebhooksHTTPClient: &http.Client{Timeout: time.Second * 30},

		SCEPClientValidity: *flSCEPClientValidity,
		Queue:              *flQueue,
		DMURL:              *flDMURL,
	}
	if !sm.UseDynSCEPChallenge {
		// TODO: we have a static SCEP challenge password here to prevent
		// being prompted for the SCEP challenge which happens in a "normal"
		// (non-DEP) enrollment. While security is not improved it is at least
		// no less secure and prevents a useless dialog from showing.
		sm.SCEPChallenge = "vmit"
	}

	if err := sm.Setup(logger); err != nil {
		stdlog.Fatal(err)
	}
	syncer, err := sm.CreateDEPSyncer(logger)
	if err != nil {
		stdlog.Fatal(err)
	}

	var removeService block.Service
	{
		svc, err := block.New(sm.RemoveDB)
		if err != nil {
			stdlog.Fatal(err)
		}
		removeService = block.LoggingMiddleware(logger)(svc)
	}

	devDB, err := devicebuiltin.NewDB(sm.DB)
	if err != nil {
		stdlog.Fatal(err)
	}

	devWorker := device.NewWorker(devDB, sm.PubClient, logger)
	go devWorker.Run(context.Background())

	userDB, err := userbuiltin.NewDB(sm.DB)
	if err != nil {
		stdlog.Fatal(err)
	}
	userWorker := user.NewWorker(userDB, sm.PubClient, logger)
	go userWorker.Run(context.Background())

	bpDB, err := blueprintbuiltin.NewDB(sm.DB, sm.ProfileDB)
	if err != nil {
		stdlog.Fatal(err)
	}

	blueprintWorker := blueprint.NewWorker(
		bpDB,
		userDB,
		sm.ProfileDB,
		sm.CommandService,
		sm.PubClient,
		logger,
	)
	go blueprintWorker.Run(context.Background())

	ctx := context.Background()
	httpLogger := log.With(logger, "transport", "http")

	appDB := &appsbuiltin.Repo{Path: *flRepoPath}

	scepEndpoints := scep.MakeServerEndpoints(sm.SCEPService)
	scepComponentLogger := log.With(logger, "component", "scep")
	scepEndpoints.GetEndpoint = scep.EndpointLoggingMiddleware(scepComponentLogger)(scepEndpoints.GetEndpoint)
	scepEndpoints.PostEndpoint = scep.EndpointLoggingMiddleware(scepComponentLogger)(scepEndpoints.PostEndpoint)
	scepHandler := scep.MakeHTTPHandler(scepEndpoints, sm.SCEPService, scepComponentLogger)

	pkcs7Verifier := &crypto.PKCS7Verifier{MaxSkew: time.Duration(*flP7Skew) * time.Second}

	enrollHandlers := enroll.MakeHTTPHandlers(ctx, enroll.MakeServerEndpoints(sm.EnrollService, sm.SCEPDepot), pkcs7Verifier, httptransport.ServerErrorLogger(httpLogger))

	r, options := httputil2.NewRouter(logger)

	r.Handle("/version", version.Handler())
	r.Handle("/mdm/enroll", enrollHandlers.EnrollHandler).Methods("GET", "POST")
	r.Handle("/ota/enroll", enrollHandlers.OTAEnrollHandler)
	r.Handle("/ota/phase23", enrollHandlers.OTAPhase2Phase3Handler).Methods("POST")
	r.Handle("/scep", scepHandler)
	if *flHomePage {
		r.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
			io.WriteString(w, homePage)
		})
	}

	mdmEndpoints := mdm.MakeServerEndpoints(sm.MDMService)
	mdm.RegisterHTTPHandlers(r, mdmEndpoints, pkcs7Verifier, logger)

	// API commands. Only handled if the user provides an api key.
	if *flAPIKey != "" {
		basicAuthEndpointMiddleware := basic.AuthMiddleware("micromdm", *flAPIKey, "micromdm")

		configsvc := config.New(sm.ConfigDB)
		configEndpoints := config.MakeServerEndpoints(configsvc, basicAuthEndpointMiddleware)
		config.RegisterHTTPHandlers(r, configEndpoints, options...)

		apnsEndpoints := apns.MakeServerEndpoints(sm.APNSPushService, basicAuthEndpointMiddleware)
		apns.RegisterHTTPHandlers(r, apnsEndpoints, options...)

		devicesvc := device.New(devDB)
		deviceEndpoints := device.MakeServerEndpoints(devicesvc, basicAuthEndpointMiddleware)
		device.RegisterHTTPHandlers(r, deviceEndpoints, options...)

		profilesvc := profile.New(sm.ProfileDB)
		profileEndpoints := profile.MakeServerEndpoints(profilesvc, basicAuthEndpointMiddleware)
		profile.RegisterHTTPHandlers(r, profileEndpoints, options...)

		blueprintsvc := blueprint.New(bpDB)
		blueprintEndpoints := blueprint.MakeServerEndpoints(blueprintsvc, basicAuthEndpointMiddleware)
		blueprint.RegisterHTTPHandlers(r, blueprintEndpoints, options...)

		blockEndpoints := block.MakeServerEndpoints(removeService, basicAuthEndpointMiddleware)
		block.RegisterHTTPHandlers(r, blockEndpoints, options...)

		usersvc := user.New(userDB)
		userEndpoints := user.MakeServerEndpoints(usersvc, basicAuthEndpointMiddleware)
		user.RegisterHTTPHandlers(r, userEndpoints, options...)

		appsvc := appstore.New(appDB)
		appEndpoints := appstore.MakeServerEndpoints(appsvc, basicAuthEndpointMiddleware)
		appstore.RegisterHTTPHandlers(r, appEndpoints, options...)

		commandEndpoints := command.MakeServerEndpoints(sm.CommandService, basicAuthEndpointMiddleware)
		command.RegisterHTTPHandlers(r, commandEndpoints, options...)

		var dc depapi.DEPClient
		if sm.DEPClient != nil {
			dc = sm.DEPClient
		}
		vc := sm.VPPClient

		depsvc := depapi.New(dc, sm.PubClient)
		depsvc.Run()
		depEndpoints := depapi.MakeServerEndpoints(depsvc, basicAuthEndpointMiddleware)
		depapi.RegisterHTTPHandlers(r, depEndpoints, options...)

		depsyncEndpoints := sync.MakeServerEndpoints(sync.NewService(syncer, sm.SyncDB), basicAuthEndpointMiddleware)
		sync.RegisterHTTPHandlers(r, depsyncEndpoints, options...)

		if sm.SCEPChallengeDepot != nil {
			challengeEndpoints := challenge.MakeServerEndpoints(challenge.NewService(sm.SCEPChallengeDepot), basicAuthEndpointMiddleware)
			challenge.RegisterHTTPHandlers(r, challengeEndpoints, options...)
		}

		vppsvc := vppapi.New(vc, sm.PubClient)
		vppsvc.Run(sm.ServerPublicURL)
		vppEndpoints := vppapi.MakeServerEndpoints(vppsvc, basicAuthEndpointMiddleware)
		vppapi.RegisterHTTPHandlers(r, vppEndpoints, options...)

		r.HandleFunc("/boltbackup", httputil2.RequireBasicAuth(boltBackup(sm.DB), "micromdm", *flAPIKey, "micromdm"))
	} else {
		mainLogger.Log("msg", "no api key specified")
	}

	if *flRepoPath != "" {
		if _, err := os.Stat(*flRepoPath); os.IsNotExist(err) {
			stdlog.Fatal(err)
		}
		r.PathPrefix("/repo/").Handler(http.StripPrefix("/repo/", http.FileServer(http.Dir(*flRepoPath))))
	}

	var handler http.Handler
	if *flHTTPDebug {
		handler = httputil.HTTPDebugMiddleware(os.Stdout, true, logger.Log)(r)
	} else {
		handler = r
	}
	if *flHTTPProxyHeaders {
		handler = handlers.ProxyHeaders(handler)
	}
	handler = logutil.NewHTTPLogger(httpLogger).Middleware(handler)

	srvURL, err := url.Parse(sm.ServerPublicURL)
	if err != nil {
		return errors.Wrapf(err, "parsing serverURL %q", sm.ServerPublicURL)
	}

	serveOpts := serveOptions(
		handler,
		*flHTTPAddr,
		srvURL.Hostname(),
		logger,
		*flTLSCert,
		*flTLSKey,
		sm.ConfigPath,
		*flTLS,
		*flDisableRedirect,
	)
	err = httputil.ListenAndServe(serveOpts...)
	return errors.Wrap(err, "calling ListenAndServe")
}

// serveOptions configures the []httputil.Options for ListenAndServe
func serveOptions(
	handler http.Handler,
	addr string,
	hostname string,
	logger log.Logger,
	certPath string,
	keyPath string,
	configPath string,
	tls bool,
	disableRedirect bool,
) []httputil.Option {
	tlsFromFile := (certPath != "" && keyPath != "")
	serveOpts := []httputil.Option{
		httputil.WithACMEHosts([]string{hostname}),
		httputil.WithLogger(logger),
		httputil.WithHTTPHandler(handler),
	}
	if tlsFromFile {
		serveOpts = append(serveOpts, httputil.WithKeyPair(certPath, keyPath))
	}
	if !tls && addr == ":https" {
		serveOpts = append(serveOpts, httputil.WithAddress(":8080"))
	}
	if tls {
		serveOpts = append(serveOpts, httputil.WithAutocertCache(autocert.DirCache(filepath.Join(configPath, "le-certificates"))))
	}
	if addr != ":https" {
		serveOpts = append(serveOpts, httputil.WithAddress(addr))
	}
	if disableRedirect {
		serveOpts = append(serveOpts, httputil.WithDisableRedirect(true))
	}
	return serveOpts
}

func boltBackup(db *bolt.DB) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		err := db.View(func(tx *bolt.Tx) error {
			w.Header().Set("Content-Type", "application/octet-stream")
			w.Header().Set("Content-Disposition", `attachment; filename="micromdm.db"`)
			w.Header().Set("Content-Length", strconv.Itoa(int(tx.Size())))
			_, err := tx.WriteTo(w)
			return err
		})
		if err != nil {
			http.Error(w, err.Error(), http.StatusInternalServerError)
		}
	}
}

func printExamples() {
	const exampleText = `
		Quickstart:
		micromdm serve -server-url=https://my-server-url -tls-cert tls.crt -tls-key tls.key
		`
	fmt.Println(exampleText)
}
